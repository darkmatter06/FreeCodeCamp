 Param(
     [string]$ci,
	 [string]$alertid,
	 [string]$logtxt,
	 [string]$user4,
	 [string]$user1,    #original source
	 [string]$severity, 
	 [string]$user3,
	 [string]$loginuser
	 )
$qhost = $(Get-WmiObject Win32_Computersystem).name
$logtxt = $user1 + " " + $logtxt
Start-Sleep -s 2    #while running in parrallel

#make loginuser as AutoRaised if not manually raised
if ($loginuser -Match "Not") 
{
$loginuser = "AutoRaised"
}
else
{
$loginuser = $loginuser
}

#make proper CI if it come with placeholder
if ($ci -Match "placeholder") 
{
$ci = $ci.Replace("placeholder", "")
}

#make proper CI for prognosis
if ($ci -Match "andrp_") 
{
$ci = $ci.Replace("andrp_", "\tandrp_")
}

#make proper CI for prognosis
if ($ci -Match "nbprd_") 
{
$ci = $ci.Replace("nbprd_", "\fnbprd_")
}

write-host inci $ci inci 
write-host alert $alertid alert
write-host intxt $logtxt intxt
write-host usr4 $user4 usr4
write-host sev $severity sev 
write-host usr3 $user3 usr3
write-host logn $loginuser logn
#===============================================================================
#  06 may 2015 Quinton Created
#  06 may 2015 que added alert generated yes
#  08 may 2015 called with powershell.exe powershell.exe -executionpolicy remotesigned -File "d:\entmanutils\psincupd.ps1" "$[Host Name]" $[Alert ID with domain ID] $[Detail] $[Alert User Attribute 4] $[Alert User Attribute 1] $[Alert Severity]
#  22 Jul 2015 Simon changed Get CiHandle doSelect for CI from system_name field to name field
#  24 Jul 2015 Simon added environment zprod_test to cater for Mainframe Live or Test incidents
#  20 Aug 2015 Simon updated CI get handle section to pull in the CI group & pull in only one CI if there's multiple active CIs
#  20 Aug 2015 Simon updated file with ci.trim above to avoid raising incidents with placeholder
#  24 Aug 2015 Simon updated file loginuser to show who raised an incident if not auto raised
#  03 Sep 2015 Simon updated file on 'check for incident' to only search for open incidents and not problems
#  15 Sep 2015 Simon updated file to cater for prognosis CIs
#  15 Sep 2015 Simon updated file to cater for raising and updating tickets for different queues i.e. Live or Test
#  16 Oct 2015 Simon changed the login username from Servicedesk to soi
#  29 Oct 2015 Simon updated the login section with a second wsdl incase the 1st one timesout
#===============================================================================
	$URI = 'http://cts-rbgsdweb04w:8080/axis/services/USD_R11_WebService?wsdl'
	$URI2 = 'http://cts-rbgsdweb04c:8080/axis/services/USD_R11_WebService?wsdl'
	$username = "Soi"
	$pwd = "S3rv1c3D3sk"
	$ws=New-WebServiceProxy -uri $URI
	write-host $ws
	
	if ($ws -notMatch "Microsoft.PowerShell.Commands.NewWebserviceProxy.AutogeneratedTypes.WebServiceProxy1rvices_USD_R11_WebService_wsdl.USD_WebService")
	{
	$ws=New-WebServiceProxy -uri $URI2
	write-host 'URI2 was used'
	}
	
	$sid = $ws.login($username,$pwd)
	$customerHandle = $ws.getHandleForUserid($sid, "Soi")
	$fnbcat = "pcat:436403"
	write-host 'customerhandle' $customerHandle

#===============================================================================
#   Get Environment
#===============================================================================
$Environment = "400001"
if ($user3 -eq "Test") 
    {
        $Environment = "400002"
    }
if ($user3 -eq "Test") 
    {
        $Environment = "400002"
    }
	switch ($user1)
		{
			SYSA	 {$Environment =	400003	}
			SYSM	 {$Environment =	400004	}
			SYSK	 {$Environment =	400005	}
			SYSW	 {$Environment =	400006	}
			SYSC	 {$Environment =	400007	}
			NAMF	 {$Environment =	400008	}
			NAMG	 {$Environment =	400009	}
			GANP	 {$Environment =	400010	}
			GANO	 {$Environment =	400011	}
			INDI	 {$Environment =	400012	}
			INDH	 {$Environment =	400013	}
			SYSS	 {$Environment =	400014	}
			SYSD	 {$Environment =	400015	}
			I183	 {$Environment =	400016	}
			I192	 {$Environment =	400017	}
			I195	 {$Environment =	400018	}
			I360	 {$Environment =	400019	}
			I220	 {$Environment =	400020	}
			I250	 {$Environment =	400021	}
			I210	 {$Environment =	400022	}
			I683	 {$Environment =	400023	}
			I695	 {$Environment =	400024	}
			I660	 {$Environment =	400025	}
			I550	 {$Environment =	400026	}
			I560	 {$Environment =	400027	}
			I130	 {$Environment =	400028	}
			I160	 {$Environment =	400029	}
			I260	 {$Environment =	400030	}
			I280	 {$Environment =	400031	}
			IMSS	 {$Environment =	400032	}
			I601	 {$Environment =	400033	}
		}
#===============================================================================
#   Get Category handle
#===============================================================================

    $attrVal = "persistent_id"
    [xml]$ciinfo = $ws.doSelect($sid, "pcat", "sym = '$user4' ", -1,$attrVal)
    if ($ciinfo.UDSObjectList.UDSObject.Handle) { 
	  $cathand = $ciinfo.UDSObjectList.UDSObject.Handle
	  $cathand
	  
	 write-host 'cathand' $cathand
	 			
    }  	
	if (!$cathand) {$cathand = 'pcat:436403' 
		write-host cathand $cathand}
#===============================================================================
#   Get CiHandle
#===============================================================================

    $attrVal = "persistent_id", "resource_contact"
    [xml]$ciinfo = $ws.doSelect($sid, "nr", "name = '$ci' ", 1,$attrVal)
	
	$grp = $ciinfo.udsobjectlist.UDSObject.Attributes.attribute | Where-Object {$_.AttrName -match "resource_contact" }
	
    if ($ciinfo.UDSObjectList.UDSObject.Handle) { 
	  $cihand = $ciinfo.UDSObjectList.UDSObject.Handle
	  $cihand = $cihand.Trim("nr:")
	# write-host 'cihandle' $cihand
    }  
	
	if ($grp.AttrValue) { 
	  $cigrp = "cnt:"+$grp.AttrValue
	 
	 write-host 'cigroup' $cigrp
    } 
	if (!$cigrp) {$cigrp = 'A68E49BE56123B47BF8272AB1ED9FBC4' } 
#===============================================================================
#===============================================================================
    if(!$cihand) {
	
		$discci = "discovered_ci" 
		#default ci name for discovered hardware
		
        write-host 'ci '$ci' not found'
       "'discovered hardware ci created for    ',$ci,$logtxt" |out-file d:\psoutlog.txt -noclobber -append
	   	$cihand = ''
		$requestHandle = ""
		$attrVal = "persistent_id"
		$attrVals = "name","$ci", "system_name","$ci","dns_name","$ci","class", "2", "tenant","ED1774CA6999EF4EB3E25E582549E8CF"
	 
		$ws.createObject($sid, "nr",$attrVals,$attrVal, [ref]$cihand, [ref]$requestHandle)
		#write-host "handle from discover hardware" $cihand
		
		Start-Sleep -s 4
		 [xml]$ciinfo = $ws.doSelect($sid, "nr", "name = '$discci' ", -1,$attrVal)
         $cihand = $ciinfo.UDSObjectList.UDSObject.Handle
                   $cihand = $cihand.Trim("nr:")
                   $cihand

	}
 
 
 
 
#===============================================================================
#  have CI now check for open incident
#===============================================================================
	#$attrVal = "persistent_id","ref_num"
	$attrVal =  "ref_num"
    [xml]$incinfo = $ws.doSelect($sid, "cr", "affected_resource = U'$cihand' and active = 1  and zprod_test = $environment", 1,$attrVal)
	
	$requestnumber = $incinfo.UDSObjectList.UDSObject.attributes.attribute.attrvalue | Select-Object -first 1
	write-host "qqrequest"   $requestnumber
	
	if ($requestnumber -match "IN") #only check for incident not problems
	{
	#$incinfo.UDSObjectList.UDSObject.handle
	$incHandle = $incinfo.UDSObjectList.UDSObject.handle | Select-Object -first 1
	write-host $inchandle "from inc"
    #write-host 'incident handle' $incinfo.UDSObjectList.UDSObject.handle
	#write-host 'incident handle' $incinfo.UDSObjectList.UDSObject.handle
    }  
  
   
   
   
   
    if ($inchandle){
        $ws.logcomment($sid, $incHandle,"$logtxt", 0 )
        
        $outline = "'incident '$requestnumber'updated',$ci,$logtxt "
        $outline | out-file d:\psoutlog.txt -noclobber -append
    } 
    else {
        $requestHandle = ""
        $requestNumber = ""
        $prop = ""
        $attr = "persistent_id"
		$externalsystem = "psincupd $qhost $loginuser"
      #  $attrVal = "customer", $customerHandle, "category", "pcat:436403", "summary", "$logtxt", "description", "$logtxt", "type","crt:182","affected_resource", "$cihand", "external_system_ticket", "$externalsystem", "z365_alert", "1"
	    $attrVal = "customer", $cigrp, "category", $cathand, "summary", "$logtxt", "description", "$logtxt", "type","crt:182","affected_resource", "$cihand", "external_system_ticket", "$externalsystem", "z365_alert", "1", "zprod_test", "$environment"
      
        $qq = $ws.createRequest($sid, $customerHandle, $attrVal, $prop, "", $attr, [ref]$requestHandle, [ref]$requestNumber)
        write-host 'incident number' $requestnumber
		write-host 'requesthandle' $requestHandle
        "'incident ',$requestnumber,'created',$ci,$logtxt" |out-file d:\psoutlog.txt -noclobber -append
    }
$ws.logout($sid)

#===============================================================================
#  update alert 
#===============================================================================

function Ignore-SelfSignedCerts {
    add-type -TypeDefinition  @"
        using System.Net;
        using System.Security.Cryptography.X509Certificates;
        public class TrustAllCertsPolicy : ICertificatePolicy {
            public bool CheckValidationResult(
                ServicePoint srvPoint, X509Certificate certificate,
                WebRequest request, int certificateProblem) {
                return true;
            }
        }
"@
    [System.Net.ServicePointManager]::CertificatePolicy = New-Object TrustAllCertsPolicy
}#function
#And then I called the function in my Begin block of my main function:
Ignore-SelfSignedCerts

$SNowUser = "bsmadmin"
$SNowPass = ConvertTo-SecureString –String "B^mAdm3n"  –AsPlainText -Force
$SNowCreds = New-Object –TypeName System.Management.Automation.PSCredential –ArgumentList $SNowUser, $SNowPass
#$alertid = 4503599627370766
$response = Invoke-restmethod -Uri "https://rbgbsmdev02:7403/rest/alert/$alertid" -Credential $SNowCreds -Method get
$response.alertdefinition
$form = $response.alertdefinition
$form | Format-List

$form.ticketid =  "$requestnumber"
$form.ticketid
#$form.ticketid = "'http://cts-rbgsdweb04c/CAisd/pdmweb.exe?OP=SEARCH+FACTORY=cr+SKIPLIST=1+QBE.EQ.id=$requestnumber'"
 
$response = Invoke-restmethod -Uri "https://rbgbsmdev02:7403/rest/alert/$alertid" -Credential $SNowCreds -Method put -body $form -ContentType application/xml 
 
exit 

 





